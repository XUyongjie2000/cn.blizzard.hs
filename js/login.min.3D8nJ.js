$("#submit").addClass("unbind"),$(function(){loginForm.init(),InfoPanel.init(),EmbeddedLogin.init()});var loginForm={accountName:$("#accountName"),alertCookie:$("#cookie-check"),alertHolder:$("#display-errors"),alertJsHolder:$("#js-errors"),csrfTokenFields:$('input[name="csrftoken"]'),password:null,passwordForm:$("#password-form"),passwordFill:".",submitButton:$("#submit"),srpClientSession:null,srpClientCredentials:null,inputPassword:$("#password"),inputUpgradeVerifier:$("#upgradeVerifier"),inputUseSrp:$("#useSrp"),inputSrpEnabled:$("#srpEnabled"),inputPublicA:$("#publicA"),inputClientEvidenceM1:$("#clientEvidenceM1"),networkErrorMessage:$("body").attr("data-network-error-message"),thirdPartyLoginButtons:$("form.third-party-login button"),loadedTime:(new Date).getTime(),csrfTokenRefreshIntervalMillis:6e5,preventDefault:function(e){e.preventDefault()},init:function(){this.setSubmitButtonDisabled(),this.checkCookie(),this.setFocus(),this.setSrpAjaxCall(),this.setCaptcha(loginForm.passwordForm),this.initThirdPartyLoginButtons(),this.initPasswordFields()},setSrpAjaxCall:function(){this.submitButton.bind("click",this.preventDefault).click(function(){try{loginForm.getSrpData(Core.locale)}catch(e){setTimeout(function(){loginForm.submitButton.removeAttr("disabled").unbind("click").click()})}})},setSubmitButtonDisabled:function(){this.submitButton.removeClass("unbind")},checkCookie:function(){var e=navigator.cookieEnabled;e||($(loginForm.alertCookie).removeClass("hide"),$(loginForm.alertJsHolder).removeClass("hide"))},setFocus:function(){"responsive"!==Core.userAgent&&(loginForm.accountName.val()?loginForm.inputPassword.focus():loginForm.accountName.focus())},setCaptcha:function(e){e.hasClass("captcha-required")&&$("#captcha-anchor").click(function(e){e.preventDefault(),$("#sec-string").attr("src","/login/captcha.jpg?"+(new Date).getTime())})},getSrpData:function(e){var t=loginForm.passwordForm.find('input[name="accountName"]').val();$.ajax({method:"POST",url:"/login/srp?csrfToken=true",data:JSON.stringify({inputs:[{input_id:"account_name",value:t}]}),dataType:"json",beforeSend:function(t){t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("Accept-Language",e)}}).done(function(e){loginForm.onSuccess(e).then(function(){loginForm.submitButton.removeAttr("disabled").unbind("click").click().addClass("unbind")})["catch"](function(){loginForm.submitButton.removeAttr("disabled").unbind("click").click().addClass("unbind")})}).fail(function(e){loginForm.onFail(e)}).complete(function(e){loginForm.onComplete(e)})},onSuccess:function(e){if("false"===this.inputSrpEnabled.val())return Promise.resolve();var t=this;return loginForm.updateCsrfTokenFields(e.csrf_token),t.password=t.inputPassword.val(),t.srpClientSession=new srp6aRoutines.ClientSession(e.modulus,e.generator,e.hash_function,e.version,e.iterations,e.eligible_credential_upgrade,window.serverResourceUrl),t.srpClientSession.step1(e.username,t.password,e.salt,e.public_B).then(function(n){return t.srpClientCredentials=n,null!==t.password&&t.inputPassword.val(Array(t.password.length+1).join(t.passwordFill)),1===e.version&&e.eligible_credential_upgrade&&"false"!==t.inputSrpEnabled.val()?new Promise(function(n){var i=new Worker(window.upgradeResourceUrl);i.onmessage=function(e){var o=e.data[0];t.inputUpgradeVerifier.val(o),t.fillSrpFields(),i.terminate(),n()},i.postMessage([window.accountPasswordUrl,e,t.password])}):void t.fillSrpFields()})},fillSrpFields:function(){this.inputPublicA.val(this.srpClientCredentials.publicA.toString(16)),this.inputClientEvidenceM1.val(this.srpClientCredentials.clientEvidenceM1.toString(16)),this.inputUseSrp.val("true")},onFail:function(e){if(navigator.onLine&&0!=e.status)var t=JSON.parse(e.responseText),n=t.error_code,i=t.support_error_code,o=t.error_message;else var n="NETWORK_ERROR",i="",o=loginForm.networkErrorMessage;if(loginForm.alertHolder.length&&loginForm.alertHolder.remove(),i)var s=o+" <a href='"+Core.secureSupportUrl+"article/"+i+"' rel='external' target='_blank'>"+i+"</a> <i class='icon-external-link'></i>";else var s=o;loginForm.alertJsHolder.html(s).removeClass("hide"),this.inputPassword.val(""),loginForm.submitButton.button("reset"),EmbeddedLogin.errorHandlerRegistration&&EmbeddedLogin.errorHandlerRegistration(n,i,o)},onComplete:function(e){var t=/^([a-zA-Z0-9_.-])+@(([a-zA-Z0-9-])+.)+([a-zA-Z0-9]{2,4})+$/;t.test(e.username)||"responsive"!==Core.userAgent||loginForm.submitButton.button("reset")},calculateTogglePadding:function(e,t){var n=function(e){return parseInt(e.replace(/[^-?\d*]/g,""))},i=n(t.css("padding-left"))+t.width()+n(t.css("padding-right"));i>0&&e.css("padding-right",i+"px")},updateCsrfTokenFields:function(e){[this.csrfTokenFields].forEach(function(t){t.val(e)})},refreshCsrfToken:function(e){$.ajax({method:"POST",url:"/login/csrf-token",async:!1}).done(function(t){loginForm.updateCsrfTokenFields(t),$(e.target).unbind("click").click()})},initThirdPartyLoginButtons:function(){(new Date).getTime();[this.thirdPartyLoginButtons].forEach(function(e){e.bind("click",this.preventDefault).click(function(e){loginForm.refreshCsrfToken(e)})})},initPasswordFields:function(){if(null!=BlzPassword){var e=new BlzPassword(document.querySelector("#password"));e.init()}}},InfoPanel={cssHide:"hide",cssShow:"show",cssGrid:"info-active",leftPanel:"#info-wrapper",rightPanel:"#login-wrapper",phoneInfoToggle:"#info-phone-toggle",phoneInfoClose:"#info-phone-close",title:null,body:null,enabled:null,domReady:!1,init:function(){this.domReady=!0,this.$leftPanel=$(this.leftPanel),this.$rightPanel=$(this.rightPanel),this.$mobileToggle=$(this.phoneInfoToggle),this.$mobileClose=$(this.phoneInfoClose),this.enabled&&this.toggle(this.enabled,this.title,this.body),this.enableMobile()},toggle:function(e,t,n){this.title=t,this.body=n,this.enabled=e;var i="InfoPanel.toggle called.";return this.domReady&&(e?(this.$leftPanel.find(".info-title").html(t),this.$leftPanel.find(".info-body").html(n),this.$mobileToggle.html(t),this.$leftPanel.removeClass(this.cssHide),this.$rightPanel.addClass(this.cssGrid),this.$mobileToggle.removeClass(this.cssHide)):(this.$leftPanel.addClass(this.cssHide),this.$rightPanel.removeClass(this.cssGrid),this.$mobileToggle.addClass(this.cssHide)),i+="Dom ready."),i},enableMobile:function(){var e=this,t=function(e,t,n){e.stopPropagation(),e.preventDefault(),t.removeClass(InfoPanel.cssHide),n.addClass(InfoPanel.cssHide)};this.$mobileToggle.on("click",function(n){t(n,e.$leftPanel,e.$rightPanel)}),this.$mobileClose.on("click",function(n){t(n,e.$rightPanel,e.$leftPanel)})}},EmbeddedLogin={inputAccountName:null,inputPassword:null,inputPersistLogin:$("#persistLogin"),inputAccountNameId:"accountName",inputPasswordId:"password",errorContainer:null,errorContainerId:"#display-errors",jsErrorContainer:null,jsErrorContainerId:"#js-errors",errorHandlerRegistration:null,init:function(){return this.inputAccountName=document.getElementById(this.inputAccountNameId),this.inputPassword=document.getElementById(this.inputPasswordId),this.errorContainer=$(this.errorContainerId),this.jsErrorContainer=$(this.jsErrorContainerId),this},getSubmitButton:function(){return loginForm.submitButton[0]},fillAccountName:function(e){return e?this.inputAccountName.value=e.substring(0,Math.min(320,e.length)):this.inputAccountName.value="",this},fillPassword:function(e){return e?this.inputPassword.value=e.substring(0,Math.min(128,e.length)):this.inputPassword.value="",this},setPersistLogin:function(e){this.inputPersistLogin&&this.inputPersistLogin.prop("checked",e)},registerErrorHandler:function(e){this.errorHandlerRegistration=e}};